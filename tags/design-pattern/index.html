<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><title>Tag: design pattern - TsaiHao&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="TsaiHao&#039;s Blog"><meta name="msapplication-TileImage" content="/images/logo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="TsaiHao&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="website"><meta property="og:title" content="TsaiHao&#039;s Blog"><meta property="og:url" content="https://tsaihao.github.io/"><meta property="og:site_name" content="TsaiHao&#039;s Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://tsaihao.github.io/img/og_image.png"><meta property="article:author" content="Tsai Hao"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://tsaihao.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://tsaihao.github.io"},"headline":"TsaiHao's Blog","image":["https://tsaihao.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Tsai Hao"},"publisher":{"@type":"Organization","name":"TsaiHao's Blog","logo":{"@type":"ImageObject","url":"https://tsaihao.github.io/images/logo.svg"}},"description":""}</script><link rel="icon" href="/images/logo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo.svg" alt="TsaiHao&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com">GitHub</a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/TsaiHao"><i class="zaijun&#039;s github"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">design pattern</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-03-05T22:31:16.000Z" title="3/5/2023, 10:31:16 PM">2023-03-05</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-03-06T05:58:24.559Z" title="3/6/2023, 5:58:24 AM">2023-03-06</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/Self-Registration-Factory-Pattern-in-Cpp/">Self-Registration Factory Pattern in C++</a></h1><div class="content"><h2 id="Usage-Scenarios"><a href="#Usage-Scenarios" class="headerlink" title="Usage Scenarios"></a>Usage Scenarios</h2><p>Implementing a typical factory pattern in C++ is not complicated, take the common Shape class as an example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ShapeFactory.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Shape.h&quot;</span>        <span class="comment">// class Shape</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Triangle.h&quot;</span>     <span class="comment">// class Triangle: public Shape</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Circle.h&quot;</span>       <span class="comment">// class Circle: public Shape</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_ptr&lt;Shape&gt; <span class="title">createShape</span><span class="params">(std::string_view name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="string">&quot;triangle&quot;</span>) <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;Shape&gt;(<span class="keyword">new</span> <span class="built_in">Triangle</span>());</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="string">&quot;circle&quot;</span>) <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;Shape&gt;(<span class="keyword">new</span> <span class="built_in">Circle</span>());</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This method is pretty straightforward and is used more, but there are two disadvantages:</p>
<ol>
<li>Each concrete class implementation must be manually registered in the <code>ShapeFactory.cpp </code>. Over time, this file will be longer and there will be too many if-else branches eventually;</li>
<li>It is not easy to do isolation of function macros, and there will be nesting of preprocessor commands with poor readability after adding platform macros.</li>
</ol>
<p>You can dynamically generate list files such as codec_list .cin FFmpeg to solve the second problem. As a cross-platform library, FFmpeg faces the very same problem of more complex functional options. Its solution is to dynamically generate this list file for as long as possible during the configuration time. Only the enabled codec will appear in the list, which looks relatively clean.</p>
<p>This article will introduce another way to solve the above two problems: the self-registered factory pattern.</p>
<h2 id="Implementation-and-Principles"><a href="#Implementation-and-Principles" class="headerlink" title="Implementation and Principles"></a>Implementation and Principles</h2><p>Self-registration exploits the global static variable or class static member automatic initialization mechanism. In the constructor of a static variable, it will register itself into the factory method implicitly. C programming language can achieve a similar effect through <code>__attribute__ ((constructor)) </code>.</p>
<p>For example, the Shape example above can be written as:</p>
<p><em>registry.h</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ShapeType&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">registerShape</span><span class="params">(std::string_view name)</span> </span>&#123;</span><br><span class="line">    ShapeFactory::<span class="built_in">instance</span>().<span class="built_in">registerShape</span>(name, []() &#123;</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;Shape&gt;(<span class="keyword">new</span> <span class="built_in">ShapeType</span>());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>circle.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span>: <span class="keyword">public</span> Shape &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Circle</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">area</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> m_radius = <span class="number">0</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> m_registered;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Circle::m_registered = <span class="built_in">registerShape</span>&lt;Circle&gt;(<span class="string">&quot;Circle&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">Circle::area</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3.14</span> * m_radius * m_radius;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Circle::m_registered</code> is only used to collect the return value of the registered function and ensure that it is called. The registered function call occurs before entering the main function. After entering the main function, you can directly use the factory class to create an instance.</p>
<p><em>main.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> shape = ShapeFactory::<span class="built_in">instance</span>().<span class="built_in">createShape</span>(<span class="string">&quot;Circle&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (shape)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;shape created&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;shape not found&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The advantage of this is obvious, since the registration of the creator takes place in the Circle source file. If we decide to disable the Circle class through the feature option, just rule out this file in the build file, no need to modify the code elsewhere, and no need to set up some functional macros to isolate the code. We don’t even need to declare Circle in a header file since there is no direct reference to this class anywhere else!</p>
<p>This method is also highly suitable for dynamic loading plug-ins during runtime. Suppose the Circle class is designed as a plug-in, the host program only needs to invoke <code>dlopen </code> function to load the <code>Circle.so</code>, and it will register itself into the list without any additional need for read information methods.</p>
<p>The sample code above can be found in different branches here:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TsaiHao">TsaiHao</a>&#x2F;<strong><a target="_blank" rel="noopener" href="https://github.com/TsaiHao/SelfRegisterFactory">SelfRegisterFactory</a></strong></p>
<p>But this approach also inherently has some problems that are not easy to ignore. The following will introduce its shortcomings and some compromise methods.</p>
<h2 id="Problems-in-Practice"><a href="#Problems-in-Practice" class="headerlink" title="Problems in Practice"></a>Problems in Practice</h2><h3 id="Symbol-Stripping-of-Static-Linking"><a href="#Symbol-Stripping-of-Static-Linking" class="headerlink" title="Symbol Stripping of Static Linking"></a>Symbol Stripping of Static Linking</h3><p>This is the most direct problem with the self-registration method, as the cost of implementing the code unitization above. For a static library, the linker only copies the object files directly used by the program during the linking phase. Therefore, the above <code>Circle.o</code> object file will be removed without notifying because the Circle class has no code reference other than itself!</p>
<p>When we <strong>have to use static linking</strong> without giving up the self-registration method, we can:</p>
<ol>
<li><p>Use some compile options to force the link target to depend on self-registered symbols, in clang &#x2F; gcc , this option is <code>-u</code>, see <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/ClangCommandLineReference.html#cmdoption-clang-u-arg">Clang command line argument reference - Clang 17.0.0git documentation </a>. In the above example, add an INTERFACE link option to the shape class in CMake :</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_options</span>(shape INTERFACE -u__ZN6Circle12m_registeredE)</span><br></pre></td></tr></table></figure>

<p>After that, any target links <code>libshape.a </code> library will default rely on <code>Circle:: m_registerd</code>, thereby forcing the linker to use <code>Circle.o</code> object file.</p>
</li>
<li><p>Directly make the self-registered source file participate in the compilation of the upper-level target, that is, not compress <code>Circle.o</code> into the libshape.a library, but directly link the object file to the upper-level target as an additional subsidiary of the library. The implementation of CMake is:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_sources</span>(shape INTERFACE <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/shape/impl/Circle.cpp)</span><br></pre></td></tr></table></figure>

<p>In this way, all the targets that link the shape library will directly use <code>Circle.cpp</code> as their own source files so that the linker will not directly delete a target file such as <code>Circle.o</code>.</p>
</li>
</ol>
<p>The above two methods are highly dependent on the compilation and CMake system. If you need cross-platform you need a more general method which I have not found yet.</p>
<h3 id="The-Construction-Order-of-Static-Variables"><a href="#The-Construction-Order-of-Static-Variables" class="headerlink" title="The Construction Order of Static Variables"></a>The Construction Order of Static Variables</h3><p>Because the factory uses global variables to register, you must be careful not to rely on their order, and the relevant operations should be carried out after entering the main function as much as possible, for example:</p>
<ol>
<li>The map that holds the creator in the Factory must be a static variable in the function scope instead of the global scope;</li>
<li>Do not create or refer to this factory in the construction of other static variables.</li>
</ol>
<h3 id="Who-Are-Using-This"><a href="#Who-Are-Using-This" class="headerlink" title="Who Are Using This"></a>Who Are Using This</h3><p>Clang’s plugins and various modules of clang-tidy in <a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project">Project LLVM </a> use this technique:</p>
<ol>
<li><p>Clang plugin, see <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/ClangPlugins.html">Clang Plugins - Clang 17.0.0git documentation </a>, dynamically loaded by dlopen at runtime, after loading, the actions in the plugin are automatically registered into the list, and there is no problem with symbol elimination.</p>
</li>
<li><p>Clang-tidy module registration. A new module is registered by initializing a static variable. to solve the above problem, clang-tidy declares an <code>extern volatile int</code> variable corresponding to each module in a public header file, and the definition of the variable instance is distributed in the module’s source file. Because of the reference of this int variable, the corresponding module will not be removed by default.</p>
</li>
<li></li>
</ol>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/avatar2.png" alt="zaijun"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">zaijun</p><p class="is-size-6 is-block">Multimedia SDE</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Category</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/TsaiHao"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-05T22:31:16.000Z">2023-03-05</time></p><p class="title"><a href="/blog/Self-Registration-Factory-Pattern-in-Cpp/">Self-Registration Factory Pattern in C++</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-02-18T17:25:19.000Z">2023-02-18</time></p><p class="title"><a href="/blog/Find-all-simple-circles-in-directed-graph-Johnson-Algorithm/">Find all simple circles in a directed graph - Johnson Algorithm</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-12-04T18:08:01.000Z">2022-12-04</time></p><p class="title"><a href="/blog/implementation_of_libcxx_any/">Introduction to std::any in C++</a></p><p class="categories"><a href="/categories/blog/">blog</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/blog/"><span class="level-start"><span class="level-item">blog</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/algorithm/"><span class="tag">algorithm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c++</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/design-pattern/"><span class="tag">design pattern</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/libc/"><span class="tag">libc++</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo.svg" alt="TsaiHao&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Tsai Hao</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>